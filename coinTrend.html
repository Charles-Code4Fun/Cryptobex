<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Coin Trend</title>

<style>
body {
    background: #0e1117;
    color: #e6e6e6;
    font-family: Arial;
    margin: 20px;
}
h1 {
    text-align: center;
    margin-bottom: 10px;
}
#chartContainer {
    max-width: 1100px;
    margin: 0 auto;
}
button {
    margin: 10px 0;
    padding: 8px 14px;
    background: #1f2430;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
button:hover {
    background: #2a2f3a;
}
.error {
    text-align: center;
    color: #ff6b6b;
}
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0"></script>
</head>

<body>

<button onclick="goBack()">← Back to Dashboard</button>

<h1 id="title">Coin Trend</h1>

<div id="chartContainer">
    <canvas id="ohlcChart"></canvas>
</div>

<div class="error" id="error"></div>

<script>
function goBack() {
    window.location.href = "index.html";
}

// -------- 安全获取 symbol --------
const params = new URLSearchParams(window.location.search);
let symbol = params.get("symbol");

// 防御：只允许字母、数字、下划线
if (!symbol || !/^[A-Z0-9_]+$/.test(symbol)) {
    document.getElementById("error").innerText = "Invalid symbol parameter.";
    throw new Error("Invalid symbol");
}

document.getElementById("title").innerText = symbol + " OHLC Chart";

// -------- CSV 路径 --------
const csvPath = `data/${symbol}/${symbol}_data.csv`;

// -------- 加载并解析 CSV --------
fetch(csvPath)
.then(res => {
    if (!res.ok) throw new Error("CSV not found");
    return res.text();
})
.then(text => {
    const lines = text.trim().split("\n");
    const header = lines.shift().split(",");

    const idx = {
        date: header.indexOf("Date"),
        open: header.indexOf("Open"),
        high: header.indexOf("High"),
        low: header.indexOf("Low"),
        close: header.indexOf("Close")
    };

    if (Object.values(idx).some(i => i === -1)) {
        throw new Error("CSV format invalid");
    }

    const data = lines.map(l => {
        const c = l.split(",");
        return {
            x: new Date(c[idx.date]),
            o: parseFloat(c[idx.open]),
            h: parseFloat(c[idx.high]),
            l: parseFloat(c[idx.low]),
            c: parseFloat(c[idx.close])
        };
    }).filter(d => !isNaN(d.o));

    renderChart(data);
})
.catch(err => {
    document.getElementById("error").innerText =
        "Failed to load OHLC data. Please check CSV file.";
    console.error(err);
});

// -------- 渲染 K 线 --------
function renderChart(data) {
    const ctx = document.getElementById("ohlcChart").getContext("2d");

    new Chart(ctx, {
        type: "candlestick",
        data: {
            datasets: [{
                label: symbol,
                data: data,
                color: {
                    up: "#00ff9c",
                    down: "#ff5c5c",
                    unchanged: "#aaa"
                }
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    ticks: { color: "#aaa" },
                    grid: { color: "#222" }
                },
                y: {
                    ticks: { color: "#aaa" },
                    grid: { color: "#222" }
                }
            }
        }
    });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cryptobex Quantech</title>
<style>
body { font-family: Arial; background:#0e1117; color:#e6e6e6; margin:20px;}
h1{text-align:center; margin-bottom:20px;}
.controls{display:flex; gap:12px; flex-wrap:wrap; margin-bottom:15px;}
input, select{padding:8px 10px; border-radius:6px; border:none; outline:none; background:#1c1f26; color:#fff;}
table{width:100%; border-collapse:collapse; background:#161a22; border-radius:10px; overflow:hidden;}
th, td{padding:10px; text-align:center; font-size:13px; border-bottom:1px solid #2a2f3a;}
th{background:#1f2430; cursor:pointer;}
tr:hover{background:#1d2230;}

/* Signal colors */
.signal-ATTENTION{color:#00ff9c; font-weight:bold;}
.signal-UNDERWEIGHT{color:#ff5c5c; font-weight:bold;}
.signal-WATCHLIST{color:#ffd166; font-weight:bold;}

/* Investment rating stars */
.rating { font-weight:bold; }
.rating-5 { color:#00ff9c; }  
.rating-4 { color:#7fff00; }  
.rating-3 { color:#ffd166; }  
.rating-2 { color:#ff9f1c; }  
.rating-1 { color:#ff5c5c; }

/* Risk rating stars */
.risk-star { font-weight:bold; }
.risk-low { color:#00ff9c; } 
.risk-medium { color:#ffd166; }
.risk-high { color:#ff5c5c; }

/* Score bar (Safety, Signal Quality) */
.score-bar{height:6px; border-radius:3px; background:#2a2f3a; position:relative;}
.score-fill{height:100%; border-radius:3px;}
.positive{background:#00ff9c;}
.negative{background:#ff5c5c;}

.trend-up::after{content:" ‚ñ≤"; color:#00ff9c;}
.trend-down::after{content:" ‚ñº"; color:#ff5c5c;}
.trend-flat::after{content:" ‚óè"; color:#aaa;}

@media(max-width:800px){table{display:block;overflow-x:auto;}}

/* Tooltip */
.tooltip {
    position: absolute;
    background: #1f2430;
    color: #e6e6e6;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    z-index: 1000;
    pointer-events: none;
    max-width: 300px;
    white-space: normal;
    word-break: break-word;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    display: none;
}

/* Footer */
footer {
    text-align: center;
    margin-top: 20px;
    font-size: 12px;
    color: #aaa;
}
</style>
</head>
<body>

<h1>üìä Cryptobex Rank</h1>

<div class="controls">
    <input type="text" id="search" placeholder="Search Symbol (e.g. ADA)" />
    <select id="signalFilter">
        <option value="">All Signals</option>
        <option value="ATTENTION">ATTENTION</option>
        <option value="UNDERWEIGHT">UNDERWEIGHT</option>
        <option value="WATCHLIST">WATCHLIST</option>
    </select>
</div>

<table>
<thead>
<tr>
    <th onclick="sortTable('Symbol')">Symbol</th>
    <th onclick="sortTable('Current')">Price</th>
    <th onclick="sortTable('Trend')">Trend</th>
    <th onclick="sortTable('Composite')">Composite</th>
    <th onclick="sortTable('Safety')">Safety</th>
    <th onclick="sortTable('Signal')">Signal</th>
    <th onclick="sortTable('InvestmentRating')">Investment Rating</th>
    <th onclick="sortTable('Risk')">Risk</th>
    <th onclick="sortTable('SignalQuality')">Signal Quality</th>
    <th onclick="sortTable('Return')">Return %</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<div class="tooltip" id="tooltip"></div>

<footer>
‚ö†Ô∏è This platform is not a financial service and is not responsible for investment advice.<br>
Powered by Cybex
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
let data = [];
let currentSort = { key: null, asc: true };
const tooltip = document.getElementById("tooltip");

function escapeHtml(text) {
    const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;' };
    return String(text).replace(/[&<>"']/g, m => map[m]);
}

// Investment Rating ‚Üí ÊòüÂè∑ÂíåÈ¢úËâ≤
function formatRating(rating) {
    let num = parseInt(rating) || 0;
    if(num < 1) num = 1;
    if(num > 5) num = 5;
    let stars = '‚òÖ'.repeat(num) + '‚òÜ'.repeat(5-num);
    return `<span class="rating rating-${num}">${stars}</span>`;
}

// Risk ‚Üí ÊòüÂè∑ÂíåÈ¢úËâ≤
function formatRisk(risk) {
    const r = (risk || '').toLowerCase();
    let cls='', stars='‚òÖ';
    if(r.includes('low')) cls='risk-low';
    else if(r.includes('mediate') || r.includes('medium')) cls='risk-medium';
    else cls='risk-high';
    return `<span class="risk-star ${cls}">${stars}</span>`;
}

// Score ‚Üí È¢úËâ≤ËøõÂ∫¶Êù°
function formatScore(score) {
    let s = parseFloat(score) || 0;
    let cls = s>=50 ? 'positive' : 'negative';
    return `<div class="score-bar"><div class="score-fill ${cls}" style="width:${Math.min(Math.abs(s),100)}%"></div></div>${s}`;
}

function loadCSV() {
    Papa.parse("data/crypto_rating_table.csv", {
        header: true,
        download: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results) {
            data = results.data
                .filter(d => d.Symbol)
                .map(d => ({
                    Symbol: d.Symbol,
                    Current: parseFloat(d['Current Price']) || 0,
                    Trend: (d.Trend === 'Upward Trend') ? 'up' :
                           (d.Trend === 'Downward Trend') ? 'down' : 'flat',
                    Composite: parseFloat(d['Composite Score']) || 0,
                    Safety: parseFloat(d['Safety Score']) || 0,
                    Signal: d.Signal || 'WATCHLIST',
                    InvestmentRating: d['Investment Rating'] || '',
                    Risk: d.Risk || '',
                    SignalQuality: parseFloat(d['Signal Quality Score']) || 0,
                    Return: parseFloat(d['Expected Return (%)']) || 0,
                    Conclusion: d.Conclusion || '',
                    FuturePrices: d['Future Prices'] || ''
                }));
            renderTable();
        }
    });
}

function renderTable() {
    const body = document.getElementById("tableBody");
    const search = (document.getElementById("search").value || "").toUpperCase();
    const signalF = document.getElementById("signalFilter").value;
    body.innerHTML = "";

    data
    .filter(d => (d.Symbol || "").toUpperCase().includes(search) &&
                 (signalF === "" || d.Signal === signalF))
    .forEach(d => {
        const tr = document.createElement("tr");
        tr.dataset.conclusion = escapeHtml(d.Conclusion);
        tr.dataset.future = escapeHtml(d.FuturePrices);

        tr.innerHTML = `
            <td>
              <a href="coinTrend.html?symbol=${encodeURIComponent(d.Symbol.replace('/', '_'))}"
                 style="color:#00ff9c; text-decoration:none; font-weight:bold;">
                 ${escapeHtml(d.Symbol)}
              </a>
            </td>
            <td>${d.Current}</td>
            <td class="trend-${d.Trend}">${d.Trend}</td>
            <td>${d.Composite}</td>
            <td>${formatScore(d.Safety)}</td>
            <td class="signal-${d.Signal}">${escapeHtml(d.Signal)}</td>
            <td>${formatRating(d.InvestmentRating)}</td>
            <td>${formatRisk(d.Risk)}</td>
            <td>${formatScore(d.SignalQuality)}</td>
            <td>${d.Return}%</td>
        `;
        body.appendChild(tr);
    });
}

function sortTable(key) {
    if (currentSort.key === key) currentSort.asc = !currentSort.asc;
    else currentSort = { key, asc: true };

    const trendOrder = { up: 3, flat: 2, down: 1 };
    const signalOrder = { 'ATTENTION': 3, 'WATCHLIST': 2, 'UNDERWEIGHT': 1 };

    data.sort((a,b)=>{
        let va = a[key], vb = b[key];
        if(key==='Trend'){ va = trendOrder[va] || 0; vb = trendOrder[vb] || 0; }
        else if(key==='Signal'){ va = signalOrder[va] || 0; vb = signalOrder[vb] || 0; }
        else if(key==='Risk'){ // È£éÈô©ÊéíÂ∫è
            const riskMap = {'low':3,'medium':2,'mediate':2,'high':1};
            va = riskMap[(va||'').toLowerCase()]||0;
            vb = riskMap[(vb||'').toLowerCase()]||0;
        }
        if(typeof va==='number' && typeof vb==='number') return currentSort.asc ? va-vb : vb-va;
        return currentSort.asc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
    });
    renderTable();
}

// Tooltip
document.getElementById("tableBody").addEventListener("mousemove", function(e){
    const tr = e.target.closest("tr");
    if(tr){
        tooltip.style.display = "block";
        tooltip.style.top = (e.pageY + 10) + "px";
        tooltip.style.left = (e.pageX + 10) + "px";
        tooltip.innerHTML = `<strong>Conclusion:</strong> ${tr.dataset.conclusion}<br>
                             <strong>Future Prices:</strong> ${tr.dataset.future}`;
    } else { tooltip.style.display = "none"; }
});

document.getElementById("tableBody").addEventListener("mouseleave", ()=>tooltip.style.display="none");
document.getElementById("search").addEventListener("input", renderTable);
document.getElementById("signalFilter").addEventListener("change", renderTable);

loadCSV();
</script>
</body>
</html>
